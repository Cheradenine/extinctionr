{% extends "base.html" %}
{% load actions %}
{% block title %}:: Upcoming Actions{% endblock %}
{% block og_title %}Upcoming Actions{% endblock %}
{% block og_tags %}
  <meta property="og:description" content="Upcoming Actions" />
{% endblock %}
  {% block inline_css %}
{{block.super}}
.a-dark {
    color: #000;
    text-decoration: underline;
}
table a {
    font-family: FucXed, sans-serif;
    color: #000;
    text-decoration: underline;
}
table td {
    font-size: .8em;
}
table a:hover {
    color: rgb(200, 0, 130);
}
.btn-outline-primary {
    color: rgb(152, 98, 151) !important;
    background-color: white !important;
    border-color: rgb(152, 98, 151) !important;
    border-width: 2px;
}
#list-view-btn,#calendar-view-btn {
    min-width: 8em;
}
.page-item.active .page-link {
    color: #fff !important;
    background-color: rgb(152, 98, 151) !important;
    border-color: rgb(152, 98, 151) !important;
}
.page-link {
    font-family: FucXed, sans-serif;
    color: rgb(152, 98, 151) !important;
    background-color: #fff;
}
.page-link:hover {
    color: #rgb(102, 48, 101) !important;
    background-color: #e9ecef;
    border-color: rgb(102, 48, 101) !important;
}
.table .thead-xr-pink th {
    color: #fff;
    background-color: rgb(207, 98, 151);
    border-color: rgb(151,151,151);
}
#mainbody {
    background-color: #fff !important;
}
.action-loc p {
    display: inline-block;
    text-decoration: underline !important;
}
.action-loc a {
    color: black;
}
[style*="--aspect-ratio"] > :first-child {
    width: 100%;
  }
  [style*="--aspect-ratio"] > img {  
    height: auto;
  } 
  @supports (--custom:property) {
    [style*="--aspect-ratio"] {
      position: relative;
      overflow: hidden;
    }
    [style*="--aspect-ratio"]::before {
      content: "";
      display: block;
      padding-bottom: calc(100% / (var(--aspect-ratio)));
    }  
    [style*="--aspect-ratio"] > :first-child {
      position: absolute;
      top: 0;
      left: 0;
    }  
  }
  {% endblock %}

{% block content %}
{% load info %}
{% load tz %}

<div class="row p-5">
    <h1 class="col-text text-center">Events</h1>
</div>

<div class="row p-4 m-0">
    <div class="col text-center">
        <div class="btn-group " role="group" aria-label="view data-toggle">
            <button id="list-view-btn" type="button" class="btn btn-outline-primary text-fucxed">List</button>
            <button id="calendar-view-btn" type="button" class="btn btn-primary text-fucxed">Calendar</button>
        </div>
    </div>
</div>

<section id="list-view" class="py-5" style="display:none">
    {% if upcoming %}
    {% for action in upcoming %}
    <div class="row px-4 py-4">
        <div class="col-2">
            <p class="text-center text-fucxed p-1 xr-bg-lemon">
                {{action.when|localtime|date:"M"}}<br>
                <span class="display-4">{{action.when|localtime|date:"d"}}</span></p>
        </div>
        <div class="col-6">
            <h3><a href="{{action.get_absolute_url}}" class="a-dark">{{action.html_title}}</a></h3>
            <div class="row">
                <div class="col-3">
            <i class="far fa-clock pr-1" title="Event time"></i><span class="small">{{action.when|localtime|time}}</span>
                </div>
            {% if action.location %}
            <div class="col action-loc"> <i class="fas fa-map-marker-alt pr-1" title="Map Marker"></i>
                <span class="small">{{action.location_link}}</span>
            </div>
            {% endif %}
            </div>
            <div class="text-left small">{{action.description|markdownify|truncatewords_html:30}}</div>
        </div>
        <div class="col-4">
            <div style="--aspect-ratio:16/9;">
                <img src="{{action.card_thumbnail_url}}" class="w-100 action-img" alt="Event Image">
            </div>
        </div>
    </div>
    <hr>
    {%endfor%}
    {% else %}
    <div class="col m-2 text-center">
        <p>There are no upcoming events.</p>
        <p>Why not <a href="/talk">propose a location for a talk</a> in your area?</p>
    </div>
    {% endif %}

    {% if pagination.page_count > 1 %}
    <div class="row">
        <div class="col">
    <nav aria-label="page navigation">
        <ul id="paginator" class="pagination pagination-lg justify-content-center">
          <li class="page-item {% if pagination.cur_page == 0 %}disabled{% endif %}">
            <a class="page-link" href="#" aria-label="Previous">
              <span aria-hidden="true">&laquo;</span>
              <span class="sr-only">Previous</span>
            </a>
          </li>
          {% for page, start in pagination.pages %}
          <li class="page-item {% if page == pagination.cur_page %}active{% endif %}">
              <a class="page-link" href="./?from={{start}}&count=10">{{ page|add:"1" }}</a>
          </li>
          {% endfor %}
          <li class="page-item {% if pagination.last_page %}disabled{% endif %}">
            <a class="page-link" href="#" aria-label="Next">
              <span aria-hidden="true">&raquo;</span>
              <span class="sr-only">Next</span>
            </a>
          </li>
        </ul>
    </nav>
</div>
</div>
    {% endif %}
</section>

<div id="calendar-view" class="row {% if is_cal %}pt-5{% else %}mt-3{% endif %}" style="display:none">
    <div class="col">
        <h3 class="text-center">
        <a href="?month={{last_month|date:"Y-m"}}{% if current_tag %}&tag={{current_tag}}{% endif %}#calendar"><i class="fas fa-arrow-left xr-purple"></i></a>
        <span class="mx-4">{{current_date|date:"F Y"}}</span>
        <a href="?month={{next_month|date:"Y-m"}}{% if current_tag %}&tag={{current_tag}}{% endif %}#calendar"><i class="fas fa-arrow-right xr-purple"></i></a>
        </h3>
        <h4 class="text-center"><a href="{{calendar_link}}" title="Export calendar as iCal format"><i class="far fa-calendar-alt"></i></a>{% if user.is_authenticated %} <small class="text-danger">this link is secret</small>{% endif %}</h4>
        {% if current_tag %}<h3 class="text-center">{{current_tag}} events</h3>{% endif %}
        <table class="table border table-responsive-sm">
            <thead class="thead-xr-pink small text-center text-fucxed">
                <tr>
                    <th style="width: 14%" scope="col">Sun</th>
                    <th style="width: 14%" scope="col">Mon</th>
                    <th style="width: 14%" scope="col">Tue</th>
                    <th style="width: 14%" scope="col">Wed</th>
                    <th style="width: 14%" scope="col">Thu</th>
                    <th style="width: 14%" scope="col">Fri</th>
                    <th style="width: 14%" scope="col">Sat</th>
                </tr>
            </thead>
            <tbody class="small">
                {% for week in month %}
                <tr style="height:6em">
                    {% for day in week %}
                    <td{% if forloop.first %} scope="row"{% endif %} class="{% if day.today %} border border-dark{% endif %}">
                        <h5>{% if can_add %}<a href="" data-toggle="modal" data-target="#event-modal" data-when="{{day.day.isoformat}}">{{day.day.day}}</a>{% else %}{{day.day.day}}{% endif %}</h5>
                        {% for event in day.events %}
                        {% if not event.public %}
                            <i class="fas fa-lock" title="Not public"></i> 
                        {% endif %}
                        {% if 'pending' in event.tags.names %}
                            <i class="fas fa-question" title="Pending Event"></i>
                        {% endif %}
                        <div class="{% if event.bg %}{{event.bg}}{% endif %}" style="margin:2px;padding:2px;">
                        <a href="{{event.get_absolute_url}}">{{event.html_title}}</a><br>
                        <p><i class="far fa-clock" title="Event Time"></i>&nbsp;{{event.when|localtime|date:"P"}}</p>
                        </div>
                        {% endfor %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
   </div>
</div>
{% if can_add %}
<div class="modal" tabindex="-1" role="dialog" id="event-modal">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-center">Add Event</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form method="post">
            {% csrf_token %}
        {{form.as_p}}
            <button type="submit" class="btn btn-fucxed btn-primary btn-block">Save</button>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-fucxed" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}
{% block extra_js %}
{% load static %}
<script type="text/javascript" src="{% static 'admin/js/vendor/xregexp/xregexp.min.js' %}"></script>
<script type="text/javascript" src="{% static 'admin/js/urlify.js' %}"></script>
<script type="text/javascript">
document.getElementById("id_name").onkeyup = function() {
    var e = document.getElementById("id_slug");
    if (!e._changed) { e.value = URLify(document.getElementById("id_name").value, 50, true); }
}
    $('#event-modal').on('show.bs.modal', function (event) {
        $('#event-modal input,textarea').addClass('form-control');
        var button = $(event.relatedTarget); // Button that triggered the modal
        var when = button.data('when'); // Extract info from data-* attributes
        $('#id_when').val(when);
    });

    window.addEventListener('hashchange', function() {
        show_calendar(location.hash === '#calendar');
    }, false);

    function show_calendar(show) {
        let elems = [
            {'btn': '#list-view-btn', 'view': '#list-view'},
            {'btn': '#calendar-view-btn', 'view': '#calendar-view'}
        ];
        let shown = Number(show);
        let hidden = Number(!show);
        $(elems[shown].view).show();
        $(elems[shown].btn)
            .addClass('btn-outline-primary')
            .removeClass('btn-primary');
        $(elems[hidden].view).hide();
        $(elems[hidden].btn)
            .removeClass('btn-outline-primary')
            .addClass('btn-primary');
    }
    // Toggle views:
    $('#list-view-btn').on('click', function(event) {
        location.hash = '';
    });
    $('#calendar-view-btn').on('click', function(event) {
        location.hash = 'calendar';
    });
    function set_pagination() {
        let pagelinks = $('.page-link');
        let active = $('#paginator .active').index();
        function set_href(link, idx) {
            link.prop('href', `./?from=${idx}&count=10`);
        }
        if (active != -1) {
            let from_idx = (active - 1) * 10;
            if (active > 1) {
                set_href(pagelinks.first(), from_idx - 10);
            }
            if (active < pagelinks.length - 2) {
                set_href(pagelinks.last(), from_idx + 10);
            }
        }
    }
    $(function() {
        show_calendar(window.location.hash === '#calendar');
        set_pagination();
    });
</script>
{% endblock %}